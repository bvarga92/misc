<!DOCTYPE html>
<head>
	<meta charset="UTF-8">
	<title>Set</title>

	<style>
		body{
			background-color: #E9EFD3;
		}
		#container{
			margin: auto;
			width: 50%;
		}
		#controls{
			width: 244px;
			margin: auto;
			font: 14px Verdana, sans-serif;
			font-weight: bold;
			color: #447284;
		}
		#controls button{
			background-color: #D34336;
			border: 2px solid #D34336;
			border-radius: 12px;
			padding: 8px 8px;
			text-align: center;
			font: 14px Verdana, sans-serif;
			font-weight: bold;
			color: #E9EFD3;
			outline: none;
		}
		#controls button:hover{
			background-color: #E9EFD3;
			color: #D34336;
			cursor: pointer;
		}
	</style>

	<script>
		class Card{
			constructor(shape, shading, color, number, x, y){
				this.shape = shape;
				this.shading = shading;
				this.color = color;
				this.number = number;
				this.x = x;
				this.y = y;
			}
		}

		class Game{
			constructor(){
				document.getElementById("board").height = 238;
				/* kiindulo pakli */
				this.deck = [
					new Card("diamond", "empty", "red", 1, 0, 0),
					new Card("diamond", "empty", "red", 2, 84, 0),
					new Card("diamond", "empty", "red", 3, 168, 0),
					new Card("oval", "empty", "red", 1, 252, 0),
					new Card("oval", "empty", "red", 2, 336, 0),
					new Card("oval", "empty", "red", 3, 420, 0),
					new Card("squiggle", "empty", "red", 1, 504, 0),
					new Card("squiggle", "empty", "red", 2, 588, 0),
					new Card("squiggle", "empty", "red", 3, 672, 0),
					new Card("diamond", "striped", "red", 1, 0, 61),
					new Card("diamond", "striped", "red", 2, 84, 61),
					new Card("diamond", "striped", "red", 3, 168, 61),
					new Card("oval", "striped", "red", 1, 252, 61),
					new Card("oval", "striped", "red", 2, 336, 61),
					new Card("oval", "striped", "red", 3, 420, 61),
					new Card("squiggle", "striped", "red", 1, 504, 61),
					new Card("squiggle", "striped", "red", 2, 588, 61),
					new Card("squiggle", "striped", "red", 3, 672, 61),
					new Card("diamond", "solid", "red", 1, 0, 122),
					new Card("diamond", "solid", "red", 2, 84, 122),
					new Card("diamond", "solid", "red", 3, 168, 122),
					new Card("oval", "solid", "red", 1, 252, 122),
					new Card("oval", "solid", "red", 2, 336, 122),
					new Card("oval", "solid", "red", 3, 420, 122),
					new Card("squiggle", "solid", "red", 1, 504, 122),
					new Card("squiggle", "solid", "red", 2, 588, 122),
					new Card("squiggle", "solid", "red", 3, 672, 122),
					new Card("diamond", "empty", "green", 1, 0, 183),
					new Card("diamond", "empty", "green", 2, 84, 183),
					new Card("diamond", "empty", "green", 3, 168, 183),
					new Card("oval", "empty", "green", 1, 252, 183),
					new Card("oval", "empty", "green", 2, 336, 183),
					new Card("oval", "empty", "green", 3, 420, 183),
					new Card("squiggle", "empty", "green", 1, 504, 183),
					new Card("squiggle", "empty", "green", 2, 588, 183),
					new Card("squiggle", "empty", "green", 3, 672, 183),
					new Card("diamond", "striped", "green", 1, 0, 244),
					new Card("diamond", "striped", "green", 2, 84, 244),
					new Card("diamond", "striped", "green", 3, 168, 244),
					new Card("oval", "striped", "green", 1, 252, 244),
					new Card("oval", "striped", "green", 2, 336, 244),
					new Card("oval", "striped", "green", 3, 420, 244),
					new Card("squiggle", "striped", "green", 1, 504, 244),
					new Card("squiggle", "striped", "green", 2, 588, 244),
					new Card("squiggle", "striped", "green", 3, 672, 244),
					new Card("diamond", "solid", "green", 1, 0, 305),
					new Card("diamond", "solid", "green", 2, 84, 305),
					new Card("diamond", "solid", "green", 3, 168, 305),
					new Card("oval", "solid", "green", 1, 252, 305),
					new Card("oval", "solid", "green", 2, 336, 305),
					new Card("oval", "solid", "green", 3, 420, 305),
					new Card("squiggle", "solid", "green", 1, 504, 305),
					new Card("squiggle", "solid", "green", 2, 588, 305),
					new Card("squiggle", "solid", "green", 3, 672, 305),
					new Card("diamond", "empty", "purple", 1, 0, 366),
					new Card("diamond", "empty", "purple", 2, 84, 366),
					new Card("diamond", "empty", "purple", 3, 168, 366),
					new Card("oval", "empty", "purple", 1, 252, 366),
					new Card("oval", "empty", "purple", 2, 336, 366),
					new Card("oval", "empty", "purple", 3, 420, 366),
					new Card("squiggle", "empty", "purple", 1, 504, 366),
					new Card("squiggle", "empty", "purple", 2, 588, 366),
					new Card("squiggle", "empty", "purple", 3, 672, 366),
					new Card("diamond", "striped", "purple", 1, 0, 427),
					new Card("diamond", "striped", "purple", 2, 84, 427),
					new Card("diamond", "striped", "purple", 3, 168, 427),
					new Card("oval", "striped", "purple", 1, 252, 427),
					new Card("oval", "striped", "purple", 2, 336, 427),
					new Card("oval", "striped", "purple", 3, 420, 427),
					new Card("squiggle", "striped", "purple", 1, 504, 427),
					new Card("squiggle", "striped", "purple", 2, 588, 427),
					new Card("squiggle", "striped", "purple", 3, 672, 427),
					new Card("diamond", "solid", "purple", 1, 0, 488),
					new Card("diamond", "solid", "purple", 2, 84, 488),
					new Card("diamond", "solid", "purple", 3, 168, 488),
					new Card("oval", "solid", "purple", 1, 252, 488),
					new Card("oval", "solid", "purple", 2, 336, 488),
					new Card("oval", "solid", "purple", 3, 420, 488),
					new Card("squiggle", "solid", "purple", 1, 504, 488),
					new Card("squiggle", "solid", "purple", 2, 588, 488),
					new Card("squiggle", "solid", "purple", 3, 672, 488)
				];
				/* keveres */
				for(let i=80; i>0; i--){
					const j = Math.floor(Math.random() * (i + 1));
					[this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
				}
				/* 12 kartyat lerakunk */
				this.board = [];
				for(let i=0; i<12; i++) this.board.push(this.deck.pop());
				/* kirajzolas */
				for(let col=0; col<3; col++)
					for(let row=0; row<4; row++)
						document.getElementById("board").getContext("2d").drawImage(document.getElementById("deckimg"), this.board[3*row+col].x, this.board[3*row+col].y, 76, 55, col * 82, row * 61, 76, 55);
				/* egyeb segedvaltozok */
				this.highlightedCards = [];
				this.setsFound = 0;
				this.updateCounters();
			}

			updateCounters(){
				document.getElementById("counter1").innerHTML = "Cards left in deck: " + this.deck.length;
				document.getElementById("counter2").innerHTML = "Sets found: " + this.setsFound;
			}

			deal3(){
				if(this.deck.length < 3){
					alert("No more cards left.");
					return;
				}
				if(this.checkBoard()){
					alert("Keep looking, there are sets on the board.");
					return;
				}
				this.highlightedCards = [];
				for(let i=0; i<3; i++) this.board.push(this.deck.pop());
				document.getElementById("board").height += 61;
				for(let col=0; col<3; col++)
					for(let row=0; row<this.board.length/3; row++)
						document.getElementById("board").getContext("2d").drawImage(document.getElementById("deckimg"), this.board[3*row+col].x, this.board[3*row+col].y, 76, 55, col * 82, row * 61, 76, 55);
				this.updateCounters();
			}

			cardClicked(row, col){
				const idx = 3 * row + col;
				if(this.board[idx] == null) return;
				const ctx = document.getElementById("board").getContext("2d");
				/* ha mar kijelolt kartyara kattintottak, akkor visszavonjuk a kijelolest */
				let found = false;
				for(let i=0; i<this.highlightedCards.length; i++){
					if(this.highlightedCards[i] == idx){
						found = true;
						this.highlightedCards.splice(i, 1);
						ctx.drawImage(document.getElementById("deckimg"), this.board[idx].x, this.board[idx].y, 76, 55, col * 82, row * 61, 76, 55);
						break;
					}
				}
				/* ha nem kijelolt kartyara kattintottak, es meg nem volt meg 3, akkor kijeloljuk az ujat */
				if(!found && this.highlightedCards.length < 3){
					this.highlightedCards.push(idx);
					ctx.beginPath();
					ctx.rect(col * 82 + 1, row * 61 + 1, 74, 53);
					ctx.stroke();
					if(this.highlightedCards.length == 3){
						if(this.checkSet(this.highlightedCards[0], this.highlightedCards[1], this.highlightedCards[2])){ //SET-et talalt a jatekos
							this.setsFound++;	
							if(this.deck.length >= 3){ //van meg kartya a pakliban
								if(this.board.length == 12){
									for(let i=0; i<3; i++){
										const r = Math.floor(this.highlightedCards[i] / 3);
										const c = this.highlightedCards[i] % 3;
										this.board[this.highlightedCards[i]] = this.deck.pop();
										ctx.drawImage(document.getElementById("deckimg"), this.board[this.highlightedCards[i]].x, this.board[this.highlightedCards[i]].y, 76, 55, c * 82, r * 61, 76, 55);
									}
								}
								else{ //vannak plusz sorok, nem rakunk ki ujakat, csak ujrarendezzuk a kartyakat
									this.highlightedCards.sort(function(a,b){return b-a});
									for(let i=0; i<3; i++) this.board.splice(this.highlightedCards[i], 1);
									document.getElementById("board").height -= 61;
									for(let c=0; c<3; c++)
										for(let r=0; r<this.board.length/3; r++)
											ctx.drawImage(document.getElementById("deckimg"), this.board[3*r+c].x, this.board[3*r+c].y, 76, 55, c * 82, r * 61, 76, 55);
								}
							}
							else{ //elfogytak a kartyak
								for(let i=0; i<3; i++){
									const r = Math.floor(this.highlightedCards[i] / 3);
									const c = this.highlightedCards[i] % 3;
									this.board.splice(this.highlightedCards[i], 1, null);
									ctx.clearRect(c * 82, r * 61, 76, 55);
								}
							}
							this.highlightedCards = [];
							this.updateCounters();
							if(this.deck.length == 0 && !this.checkBoard())
								setTimeout(function(){alert("You have found all sets, good job!");}, 100); //timeout nelkul csak az alert utan rajzolja ujra a canvast
						}
					}
				}
			}

			checkSet(idx1, idx2, idx3){
				if(this.board[idx1] == null || this.board[idx2] == null || this.board[idx3] == null) return false;
				let shapeOK = (this.board[idx1].shape === this.board[idx2].shape && this.board[idx2].shape === this.board[idx3].shape) || 
				              (this.board[idx1].shape !== this.board[idx2].shape && this.board[idx1].shape !== this.board[idx3].shape && this.board[idx2].shape !== this.board[idx3].shape);
				let shadingOK = (this.board[idx1].shading === this.board[idx2].shading && this.board[idx2].shading === this.board[idx3].shading) || 
				                (this.board[idx1].shading !== this.board[idx2].shading && this.board[idx1].shading !== this.board[idx3].shading && this.board[idx2].shading !== this.board[idx3].shading);
				let colorOK = (this.board[idx1].color === this.board[idx2].color && this.board[idx2].color === this.board[idx3].color) || 
				              (this.board[idx1].color !== this.board[idx2].color && this.board[idx1].color !== this.board[idx3].color && this.board[idx2].color !== this.board[idx3].color);
				let numberOK = (this.board[idx1].number === this.board[idx2].number && this.board[idx2].number === this.board[idx3].number) || 
				               (this.board[idx1].number !== this.board[idx2].number && this.board[idx1].number !== this.board[idx3].number && this.board[idx2].number !== this.board[idx3].number);
				return shapeOK && shadingOK && colorOK && numberOK;
			}

			checkBoard(){
				for(let i=0; i<this.board.length-2; i++){
					if(this.board[i] == null) continue;
					for(let j=i+1; j<this.board.length-1; j++){
						if(this.board[j] == null) continue;
						for(let k=j+1; k<this.board.length; k++){
							if(this.board[k] == null) continue;
							if(this.checkSet(i, j, k)){
								//console.log("SET: " + i + ", " + j + ", " + k); //debugolashoz
								return true;
							}
						}
					}
				}
				return false;
			}
		}

		var game = null;

		function init(){
			document.getElementById("deal3btn").addEventListener("click", function(event){
				game.deal3();
			});
			document.getElementById("board").addEventListener("click", function(event){
				const rect = document.getElementById("board").getBoundingClientRect();
				const x = event.clientX - rect.left;
				const y = event.clientY - rect.top;
				let col = null;
				for(let i=0; i*82<rect.width; i++)
					if(x >= i*82 && x <= i*6+(i+1)*76) col = i;
				if(col == null) return;
				let row = null;
				for(let i=0; i*61<rect.height; i++)
					if(y >= i*61 && y <= i*6+(i+1)*55) row = i;
				if(row == null) return;
				game.cardClicked(row, col);
			});
			start();
		}

		function start(){
			game = new Game();
		}
	</script>
</head>

<body onload="init();">
	<div style="display:none;"><img id="deckimg" src="./deck.png"></div>
	<div id="container">
		<div id="controls">
				<button onclick="start();">New game</button>
				<button id="deal3btn" style="float:right;">3 more cards</button>
			<p id="counter1"></p>
			<p id="counter2"></p>
		</div>
		<div style="text-align: center;"><canvas id="board" width="244" height="238" onmousedown="return false;"></canvas></div>
	</div>
</body>

</html>
</body>
</html>